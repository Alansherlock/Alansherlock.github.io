<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="时间不在于你拥有多少，而在于你怎样使用"><title>微信分享 | 小小博客</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">微信分享</h1><a id="logo" href="/.">小小博客</a><p class="description">时间不在于你拥有多少，而在于你怎样使用</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 历史</i></a><a href="/about/"><i class="fa fa-user"> 关于我</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入搜索关键词"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">微信分享</h1><div class="post-meta"><a href="/2019/01/15/微信/微信分享/#comments" class="comment-count"></a><p><span class="date">Jan 15, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="微信授权"><a href="#微信授权" class="headerlink" title="微信授权"></a>微信授权</h2><p>在这一步上项目中是直接调取了后台书写好的接口，在这一步也很重要，为后面分享埋下伏笔<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//http://servicetest.changan.com.cn/changan-trade-application/api/v1/weixin/redirect?url=http://servicetest.changan.com.cn/changan-b2c-web-h5/</span></span><br><span class="line"><span class="comment">// 在分享前先让用户进入当前页面的时候就必须获取授权，否则根本拿取不到openId,也进行不到下一步，通过接口也可以看出，url必须是当前页面的</span></span><br></pre></td></tr></table></figure></p>
<h2 id="获取微信config接口"><a href="#获取微信config接口" class="headerlink" title="获取微信config接口"></a>获取微信config接口</h2><p>这个接口也是由后端先接入微信</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://servicetest.changan.com.cn/changan-trade-application/api/v1/weixin/config?url=http%3A%2F%2F192.168.111.120%3A8082%2F&amp;openid=2.168.111.120%3A8082%2F</span></span><br><span class="line"><span class="comment">// 从楼上也可以判断出来需要传url和openId来给到后端，而openId则是由楼上的授权接口先获取到</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signature"</span>:<span class="string">"a6e77a6b2f0c88cdd3554d864c09f09fcf5efa7b"</span>,</span><br><span class="line">    <span class="string">"appId"</span>:<span class="string">"wxe427052c635210e8"</span>,</span><br><span class="line">    <span class="string">"jsapi_ticket"</span>:<span class="string">"gdzxN2g622vVfv3lEXnBsu4pFZhQIyBUn_7uqUP9-sD7BJOGfsbsyJfsn3rv-ulEWgm3QR1bglPYQ0iwO4WWSg"</span>,</span><br><span class="line">    <span class="comment">// 实际场景中url则会是线上地址</span></span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"http://192.168.111.120:8082/"</span>,</span><br><span class="line">    <span class="string">"nonceStr"</span>:<span class="string">"3135ec04-6f49-46bf-a21b-2b58055b9b44"</span>,</span><br><span class="line">    <span class="string">"timestamp"</span>:<span class="string">"1544582200"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="微信config-wx-config"><a href="#微信config-wx-config" class="headerlink" title="微信config (wx.config)"></a>微信config (wx.config)</h2><p>进行了楼上两个步骤后，我们开始开始进行微信API的配置，在2018这个分水岭，微信分享做了处理，分享接口有两个无法获取是否分享成功（失败监听不了的意思），但是还是能够监听success接口的回调，这两个  <code>onMenuShareTimeline`</code>onMenuShareAppMessage<code>;
还有两个新的API</code>updateAppMessageShareData<code></code>updateTimelineShareData`,这两个在实践中还是监听不到success，建议先用旧的，也可能是我太菜了哎<br>楼下的data则上楼下config接口回来并且填入的数据，一环扣一环<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wx.config(&#123;</span><br><span class="line">  debug: debug,</span><br><span class="line">  appId: data.appId,</span><br><span class="line">  timestamp: data.timestamp,</span><br><span class="line">  nonceStr: data.nonceStr,</span><br><span class="line">  signature: data.signature,</span><br><span class="line">  jsApiList: [</span><br><span class="line">    <span class="string">'onMenuShareTimeline'</span>,       <span class="comment">// 分享到朋友圈接口</span></span><br><span class="line">    <span class="string">'onMenuShareAppMessage'</span>,  <span class="comment">//  分享到朋友接口</span></span><br><span class="line">    <span class="string">'updateAppMessageShareData'</span>, <span class="comment">//1.4 分享到朋友</span></span><br><span class="line">    <span class="string">'updateTimelineShareData'</span>, <span class="comment">//1.4分享到朋友圈</span></span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="微信分享"><a href="#微信分享" class="headerlink" title="微信分享"></a>微信分享</h2><p>在这一步的<code>encodeURIComponent</code>则是因为我用的react框架中的hash模式，带了 <strong>#</strong>号，需要为后面的参数做转码，不然分享后数据会因为微信的分享机制而被截取掉（之前遇到的情况是安卓机会截取而IOS不会）；在这一步上则是在页面进入的初始上就立马调用，微信文档上有句文档叫<em>可能分享的情况下提前调用</em>’</p>
<blockquote>
<p>sendData 里面有个<code>Config.authURL</code>,这个玩意则是后端给的微信授权后重定向的接口路径，是第一步骤上的url，防止新用户进入到新页面没授权拿取不到openId,直接调用的骚操作<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//进行data的数据配置</span></span><br><span class="line"><span class="keyword">let</span> sendData = &#123;</span><br><span class="line">  title: <span class="string">'长安汽车尊享服务-活动问卷详情'</span>, <span class="comment">// 分享标题</span></span><br><span class="line">  desc: <span class="string">'长安汽车尊享服务活动问卷详情'</span>, <span class="comment">// 分享描述</span></span><br><span class="line">  link: <span class="string">`<span class="subst">$&#123;Config.authURL&#125;</span><span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(<span class="string">'#'</span> + <span class="string">'/questionnaire?'</span> + <span class="string">'id='</span> + query.id + <span class="string">'&amp;status='</span> + <span class="string">`<span class="subst">$&#123;query.status ? query.status : <span class="string">''</span>&#125;</span>`</span> + <span class="string">"&amp;mId="</span> + mld + <span class="string">"&amp;oId="</span> + old)&#125;</span>`</span>,</span><br><span class="line">  imgUrl: <span class="string">'http://servicetest.changan.com.cn/changan-mgmt-application/img/2018-11-19/1542596562162.jpg'</span>, <span class="comment">// 分享图标</span></span><br><span class="line">  success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置成功</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Set Shareinfo ok'</span>, res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">wx.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(sendData, <span class="string">'sendData'</span>);</span><br><span class="line">    wx.updateAppMessageShareData(sendData);</span><br><span class="line">    wx.updateTimelineShareData(sendData);</span><br><span class="line">    wx.onMenuShareTimeline(sendData);</span><br><span class="line">    wx.onMenuShareAppMessage(sendData);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'WXSDK is Ready!!'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.fail(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.error(<span class="string">"接口出错！"</span> + e);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</blockquote>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2019/01/15/正则/校验手机号正则/" class="pre">书写一个手机号校验的正则</a><a href="/2019/01/15/其他/获取本地IP所有地理位置及所在城市/" class="next">获取本机IP及所有城市</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjIyNS8xMjc2MA=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#微信授权"><span class="toc-text">微信授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取微信config接口"><span class="toc-text">获取微信config接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微信config-wx-config"><span class="toc-text">微信config (wx.config)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微信分享"><span class="toc-text">微信分享</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/Python/爬取酷狗付费歌曲/">爬取酷狗付费歌曲</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/正则/身份证验证/">书写一个身份证校验的正则</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/正则/网址校验正则/">网址校验正则</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/正则/正则匹配去除某些不必要的字段/">利用正则校验匹配去掉一些不必要的数字或字母等</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/正则/校验手机号正则/">书写一个手机号校验的正则</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/微信/微信分享/">微信分享</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/其他/获取本地IP所有地理位置及所在城市/">获取本机IP及所有城市</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/其他/移动端调试开启Vconsole/">移动端开启调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/其他/移动端解决键盘收起留白/">移动端解决键盘收起留白</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/其他/移动端小知识/">移动端笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/canvas/" style="font-size: 15px;">canvas</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/前端小本/" style="font-size: 15px;">前端小本</a> <a href="/tags/移动端/" style="font-size: 15px;">移动端</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p>  |  <span>博主微信：V315746449 （记得备注哟）</span> |  <span>联系博主： </span><a rel="nofollow" target="_blank" href="https://github.com/Alansherlock"> Alan.   </a></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f72a56f6b9be98f03be5fbbc3505d8d6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>